# ===----------------------------------------------------------------------=== #
# Copyright (c) 2024, Modular Inc. All rights reserved.
#
# Licensed under the Apache License v2.0 with LLVM Exceptions:
# https://llvm.org/LICENSE.txt
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ===----------------------------------------------------------------------=== #
"""Functions for lazily downloading model weights on first execution."""

from os import mkdir
from pathlib import cwd, Path
from sys.ffi import external_call


def download_to_cache(url: String) -> Path:
    """If file doesn't exist download to `.cache` and return path."""
    cache_path = cwd() / ".cache"
    if not cache_path.is_dir():
        mkdir(cache_path)
    last_component = url.split("/")[-1]
    destination = cache_path.joinpath(last_component)
    if not destination.is_file():
        curl_command = "curl " + url + " -L -J -o " + str(destination)
        external_call["system", NoneType](curl_command.unsafe_ptr())
        _ = curl_command^
    return destination
